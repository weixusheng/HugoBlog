# 开机过程中的操作系统


今天听操作系统课的时候听到老师简单讲了几句计算机开机的过程,提到了GRUB,我一听,这不是我当初装双系统折腾过的嘛,就好奇去搜了一下开机过程OS的过程,在这里记录一下
<!--more-->

# 总体过程
进入POST -> CMOS设置 -> 读取MBR -> 控制权交给MBR -> MBR读取分区表找到其中的活动分区(Active Partition) -> MBR读取分区中的首扇区(分区引导记录PBR) -> 加载到内存中 -> PBR继续控制后续的引导过程

常见的引导程序: GRUB, BOOTMGR (GRUB!!! 我的linux开机就是这个!)
 - 核心初始化: 初始化os内核, 初始化系统核心数据, 各种寄存器, 存储系统的页表, 核心进程的构建

 - 系统初始化: 初始化文件系统, 网络系统, 控制台, 图形界面

# OS的四个过程
## 第一阶段：BIOS
上个世纪70年代初，"只读内存"（read-only memory，缩写为ROM）发明，开机程序被刷入ROM芯片，计算机通电后，第一件事就是读取它。
这块芯片里的程序叫做"基本输入输出系统"（Basic Input/Output System），简称为BIOS。BIOS是(Fireware 固件)
 - 固件: 以硬件方式存在,其中储存软件

### 硬件自检
BIOS程序首先检查，计算机硬件能否满足运行的基本条件，"加电自检"(Power-On Self-Test),缩写为POST。
初始化基本硬件:CPU, 内存, 显卡
如果硬件出现问题，主板会发出不同含义的蜂鸣，启动中止。如果没有问题，屏幕就会显示出CPU、内存、硬盘等信息。
 - 当按下Power on或Reset键后执行的第一条指令 FFFF0指令即JUMP POST跳转到POST,随后POST查找显卡BIOS,调用显卡BIOS,依次查找其他设备BIOS

### 启动顺序
硬件自检完成后，BIOS把控制权转交给下一阶段的启动程序。
BIOS需要知道，"下一阶段的启动程序"具体存放在哪一个设备(硬盘/软盘/光驱)。也就是说，BIOS需要有一个外部储存设备的排序，排在前面的设备就是优先转交控制权的设备。这种排序叫做"启动顺序"（Boot Sequence）。
BIOS的操作界面，其中有一项设置就是"设定启动顺序"。

## 第二阶段：主引导记录MBR
BIOS按照"启动顺序"，将控制权转交给排在首位的储存设备。
这时，计算机读取该设备的第一个扇区(首扇区)，也就是读取最前面的512个字节。如果这512个字节的最后两个字节是0x55和0xAA，表明这个设备可以用于启动；如果不是，表明设备不能用于启动，控制权于是被转交给"启动顺序"中的下一个设备。
最前面的512个字节，叫做"主引导记录"（Master boot record，缩写为MBR。其作用为:
1. 让用户选择不同的启动项,实现多种启动
2. 加载核心文件直接指向启动区加载操作系统
3. 跳转:将启动管理功能转交给其他loader

### 主引导记录的结构
"主引导记录"只有512个字节,它的主要作用是，指定计算机到硬盘的哪一个位置去找操作系统。即完成OS加载或启动管理
主引导记录由三个部分组成：
1. 第1-446字节：调用操作系统的机器码。
2.  第447-510字节：分区表（Partition table）。
3. 第511-512字节：主引导记录签名（0x55和0xAA）。
其中第二部分"分区表"的作用，是将硬盘分成若干个区。

### 分区表
硬盘分区有很多好处。考虑到每个区可以安装不同的操作系统，"主引导记录"因此必须知道将控制权转交给哪个区。
分区表的长度只有64个字节，里面又分成四项，每项16个字节。所以，一个硬盘最多只能分四个一级分区，又叫做"主分区"。
每个主分区的16个字节，由6个部分组成：

1. 第1个字节：如果为0x80，就表示该主分区是激活分区，控制权要转交给这个分区。四个主分区里面只能有一个是激活的
2. 第2-4个字节：主分区第一个扇区的物理位置(柱面、磁头、扇区号等等)
3. 第5个字节：主分区类型
4. 第6-8个字节：主分区最后一个扇区的物理位置
5. 第9-12字节：该主分区第一个扇区的逻辑地址
6. 第13-16字节：主分区的扇区总数。

## 第三阶段：硬盘启动
这个时期，计算机的控制权就要转交给硬盘的某个分区了

### 卷引导记录
在分区中，只有一个是激活的(Active Partition)。计算机会读取激活分区的第一个扇区(首扇区)即"卷引导记录"（Volume boot record，缩写为VBR）。
"卷引导记录"的主要作用:
指明操作系统在这个分区里的位置。然后计算机就可加载操作系统。

## 第四阶段：操作系统
控制权转交给操作系统后，操作系统的内核首先被载入内存。

# Linux启动过程
这里举例Linux的启动过程:
POST -> MBR -> KERNEL映像 -> KERNEL自解压并执行 -> 内核初始化 -> 内核启动
KERNEL映像是zlib压缩过的内核映像
KERNEL映像前端是可执行例程(实现核心硬件初始化,并解压)然后调用内核并开始启动内核引导
 - 载入程序 /sbin/init （Debian系统是/etc/initab）
 根据配置文件产生init进程,这是Linux启动后的第一个进程，pid进程编号为1，其他进程都是它的后代。然后，init线程加载系统的各个模块，比如窗口程序和网络程序，直至执行/bin/login程序，跳出登录界面，等待用户输入用户名和密码。

